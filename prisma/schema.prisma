generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum DocumentType {
  invoice
  tax_invoice
  proforma
  receipt
  sales_receipt
  cash_receipt
  quote
  estimate
  credit_note
  purchase_order
  delivery_note
}

enum DocumentStatus {
  draft
  sent
  viewed
  paid
  overdue
  cancelled
}

enum IndustryPreset {
  freelance
  contractor
  consultant
  hourly
  service
  sales
  medical
  photography
  rental
  repair
  hotel
  design
  it_tech
  artist
  commercial
}

enum EventType {
  created
  sent
  viewed
  paid
  overdue_flagged
  cancelled
}

enum UserRole {
  user
  admin
}

// ============================================
// USERS
// ============================================

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  name                String?
  passwordHash        String?
  provider            String    @default("email") // email | google
  role                UserRole  @default(user)
  businessName        String?
  businessAddress     Json?     // Address object
  businessLogoUrl     String?
  taxId               String?
  defaultCurrency     String    @default("USD")
  defaultPaymentTerms String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  documents Document[]
  clients   Client[]

  @@map("users")
}

// ============================================
// CLIENTS (saved recipient profiles)
// ============================================

model Client {
  id        String   @id @default(uuid())
  userId    String
  name      String
  email     String?
  phone     String?
  address   Json?    // Address object
  taxId     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]

  @@map("clients")
}

// ============================================
// DOCUMENTS (the core — every invoice/receipt/quote/etc.)
// This is where ALL the raw data lives.
// Every single submitted document is stored in full.
// ============================================

model Document {
  id              String          @id @default(uuid())
  userId          String?         // null for guest users
  clientId        String?
  type            DocumentType
  industryPreset  IndustryPreset?
  status          DocumentStatus  @default(draft)
  documentNumber  String
  issueDate       DateTime
  dueDate         DateTime?
  currency        String          @default("USD")

  // FULL sender details — stored as raw data, NOT anonymized
  senderInfo      Json            // SenderInfo: business name, address, email, phone, tax ID, logo

  // FULL recipient details — stored as raw data, NOT anonymized
  recipientInfo   Json            // RecipientInfo: client name, address, email, phone, tax ID

  notes           String?
  terms           String?
  templateId      String          @default("classic")

  // Financial totals
  subtotal        Decimal         @default(0) @db.Decimal(12, 2)
  taxTotal        Decimal         @default(0) @db.Decimal(12, 2)
  discountTotal   Decimal         @default(0) @db.Decimal(12, 2)
  grandTotal      Decimal         @default(0) @db.Decimal(12, 2)

  pdfUrl          String?

  // Type-specific extra fields (payment method, tracking number, HS codes, etc.)
  extraFields     Json?           // DocumentExtraFields

  // Metadata for data collection
  userAgent       String?         // Browser/device info
  ipCountry       String?         // Country from IP geolocation
  sessionId       String?         // Anonymous session tracking for guests

  // Network & Location
  ipAddress       String?
  ipGeo           Json?           // { country, region, city, postal, lat, lng, isp, org, as, timezone }

  // Business Intelligence — extracted fields
  senderEmailDomain    String?    // extracted from sender email
  recipientEmailDomain String?    // extracted from recipient email
  detectedIndustry     String?    // keyword-matched from line items
  revenueRange         String?    // categorized: <1k, 1k-5k, 5k-25k, 25k-100k, 100k+
  lineItemCount        Int?
  avgLineItemPrice     Decimal?   @db.Decimal(12, 2)

  // Link back to form session
  formSessionId   String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  sentAt          DateTime?
  paidAt          DateTime?

  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  client          Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  lineItems       LineItem[]
  events          DocumentEvent[]

  @@index([type])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([currency])
  @@index([industryPreset])
  @@index([ipCountry])
  @@index([senderEmailDomain])
  @@index([detectedIndustry])
  @@index([revenueRange])
  @@map("documents")
}

// ============================================
// LINE ITEMS (every single line item from every document)
// ============================================

model LineItem {
  id          String   @id @default(uuid())
  documentId  String
  description String
  quantity    Decimal  @db.Decimal(10, 4)
  unitPrice   Decimal  @db.Decimal(12, 2)
  taxRate     Decimal? @db.Decimal(5, 2)
  discount    Decimal? @db.Decimal(12, 2)
  lineTotal   Decimal  @db.Decimal(12, 2)
  sortOrder   Int      @default(0)

  // Extra fields: SKU, CPT code, HS code, etc.
  extraFields Json?

  createdAt   DateTime @default(now())

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("line_items")
}

// ============================================
// FORM SESSIONS (tracks every user who starts the wizard)
// Captures data even if they never click download (abandoned sessions)
// ============================================

model FormSession {
  id              String    @id @default(uuid())
  documentType    String?
  startedAt       DateTime  @default(now())
  lastActivityAt  DateTime  @default(now())
  completed       Boolean   @default(false)
  completedAt     DateTime?
  documentId      String?   // link to completed document if they downloaded

  // Device & environment
  deviceInfo      Json?     // { browser, os, screenWidth, screenHeight, mobile }
  userAgent       String?
  ipCountry       String?
  referralSource  String?   // utm params, referrer URL
  pageUrl         String?

  // Network & Location
  ipAddress       String?
  ipGeo           Json?     // { country, region, city, postal, lat, lng, isp, org, as, timezone }
  preferredLangs  String?   // Accept-Language header

  // Device Fingerprinting
  fingerprint     Json?     // all device signals (screen, GPU, canvas hash, audio hash, etc.)
  fingerprintHash String?   // SHA-256 of key signals for returning visitor detection

  // Behavioral Data
  behavioral      Json?     // { fieldTimings, editCounts, fieldOrder, pasteEvents, typingSpeeds, scrollDepth, tabSwitches, rageClicks, duration, pageLoadTime }
  mouseHeatmap    Json?     // array of { x, y, t }
  clickMap        Json?     // array of { x, y, target, t }

  // Referral & Marketing
  fullReferrer    String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?

  // Traffic Intelligence
  landingPage     String?
  searchQuery     String?
  trafficSource   String?   // organic, direct, social, referral, paid, email
  socialPlatform  String?   // facebook, twitter, linkedin, etc.
  isReturning     Boolean   @default(false)

  // Snapshot of form data at last activity (for abandoned session recovery)
  formSnapshot    Json?     // full wizard state at time of last activity

  fieldLogs       FormFieldLog[]

  @@index([documentType])
  @@index([startedAt])
  @@index([completed])
  @@index([fingerprintHash])
  @@index([trafficSource])
  @@index([utmSource])
  @@index([ipAddress])
  @@index([isReturning])
  @@map("form_sessions")
}

// ============================================
// FORM FIELD LOGS (every keystroke, debounced)
// This captures what users type even if they abandon
// ============================================

model FormFieldLog {
  id         String   @id @default(uuid())
  sessionId  String
  fieldName  String   // e.g. "senderInfo.businessName", "lineItems.0.description"
  fieldValue String   @db.Text
  loggedAt   DateTime @default(now())

  session    FormSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([fieldName])
  @@index([loggedAt])
  @@map("form_field_logs")
}

// ============================================
// DOCUMENT EVENTS (status changes, activity tracking)
// ============================================

model DocumentEvent {
  id         String    @id @default(uuid())
  documentId String
  eventType  EventType
  eventDate  DateTime  @default(now())
  metadata   Json?     // Any additional event data

  document   Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([eventType])
  @@index([eventDate])
  @@map("document_events")
}
